<!-- Probably move the stylesheet to you layout. Also make sure you include the javascript. -->
<%= stylesheet_link_tag "event_calendar" %>

<script>
function make_hidden( name, value, formid ){
    var q = document.createElement('input');
    q.type = 'hidden';
    q.name = name;
    q.value = value;
    if (formid){
      var elm = document.getElementById(formid);
      elm.appendChild(q);
    }
    else{
      document.forms[0].appendChild(q);
    }
    // if (formname){ document.forms[formname].appendChild(q); }
    // else{ document.forms[0].appendChild(q); }
}

function delete_hidden( name, value, formname ){
    var dom_obj_array = window.document.getElementsByName(name);
    for (var i=0; i<dom_obj_array.length; i++){
        if ( dom_obj_array[i].value === value ){
            element = dom_obj_array[i];
            element.parentNode.removeChild(element);
        }
    }
}
</script>

<script>
function  selectedDates(){

  $.each(dates, function(index, value){
    make_hidden('selected[]', value, 'new_event');
  });
  return true;
}
</script>
<style>
  .selected a{
    background: orange !important
  }
</style>

<h1>スケジューラ</h1>

<div style="display:inline-flex", id="table">
<img src="/img/timelabel2.png" alt="時間" width=100 height=500>
</table>
<!-- <%= link_to("newold", :controller => "events", :action => "new") %> -->
<!-- <%= link_to 'new', '#', class: 'open' %>
<%= link_to 'edit', '#', class: 'open' %> -->
<div style="display:inline-flex">
<%#=
<img src="/img/timelabel2.png" alt="時間" width=100 height=1000>
</table>%>
<br>
<br>

<table border="1", onmousedown="mouseDown(this, event); return false;" onmouseup="mouseUp(this, event);" onmousemove="mouseMove(this, event); return false;">
<head>
<caption>(H)</caption>
  <thead>
  <tr bgcolor="green">
    <tr><th>時間</th></tr>
    </tr>
  </thead>
  <tbody>
    <!-- <tr><td><a href="index">1:00</a></td></tr> -->
    <tr><td>1:00</td></tr>
    <tr><td><a href="index">2:00</a></td></tr>
    <tr><td><a href="index">3:00</a></td></tr>
    <tr class="odd"><td><a href="index">4:00</a></td></tr>
    <tr><td><a href="index">5:00</a></td></tr>
    <tr><td><a href="index">6:00</a></td></tr>
    <tr class="odd"><td><a href="index">7:00</a></td></tr>
    <tr><td><a href="index">8:00</a></td></tr>
    <tr class="odd"><td><a href="index">9:00</a></td></tr>
    <tr><td><a href="index">10:00</a></td></tr>
    <tr><td><a href="index">11:00</a></td></tr>
    <tr class="odd"><td><a href="index">12:00</a></td></tr>
    <tr><td><a href="index">13:00</a></td></tr>
    <tr class="odd"><td><a href="index">14:00</a></td></tr>
    <tr><td><a href="index">15:00</a></td></tr>
    <tr><td><a href="index">16:00</a></td></tr>
    <tr class="odd"><td><a href="index">17:00</a></td></tr>
    <tr><td><a href="index">18:00</a></td></tr>
    <tr class="odd"><td><a href="index">19:00</a></td></tr>
    <tr><td><a href="index">20:00</a></td></tr>
    <tr><td><a href="index">21:00</a></td></tr>
    <tr class="odd"><td><a href="index">22:00</a></td></tr>
    <tr><td><a href="index">23:00</a></td></tr>
    <tr class="odd"><td><a href="index">24:00</a></td></tr>
  </tbody>
  </head>
</table>

<table border>
<head>
  <caption>today</caption>
  <thead>
  <tr bgcolor="green">
    <tr><th>予定</th><th>場所</th></tr>
    </tr>
  </thead>
  <tbody>
    <tr><td><a href="index">1001</a></td><td>aaaa</td></tr>
    <tr class="odd"><td><a href="index">2001</a></td><td>bbbb</td></tr>
    <tr><td><a href="index">3001</a></td><td>cccc</td></tr>
    <tr class="odd"><td><a href="index">4001</a></td><td>dddd</td></tr>
    <tr><td><a href="index">5001</a></td><td>eeee</td></tr>
    <tr><td><a href="index">1001</a></td><td>aaaa</td></tr>
    <tr class="odd"><td><a href="index">2001</a></td><td>bbbb</td></tr>
    <tr><td><a href="index">3001</a></td><td>cccc</td></tr>
    <tr class="odd"><td><a href="index">4001</a></td><td>ddd</td></tr>
    <tr><td><a href="index">5001</a></td><td>eeee</td></tr>
    <tr><td><a href="index">1001</a></td><td>aaaa</td></tr>
    <tr class="odd"><td><a href="index">2001</a></td><td>bbbb</td></tr>
    <tr><td><a href="index">3001</a></td><td>cccc</td></tr>
    <tr class="odd"><td><a href="index">4001</a></td><td>dddd</td></tr>
    <tr><td><a href="index">5001</a></td><td>eeee</td></tr>
    <tr><td><a href="index">1001</a></td><td>aaaa</td></tr>
    <tr class="odd"><td><a href="index">2001</a></td><td>bbbb</td></tr>
    <tr><td><a href="index">3001</a></td><td>cccc</td></tr>
    <tr class="odd"><td><a href="index">4001</a></td><td>dddd</td></tr>
    <tr><td><a href="index">5001</a></td><td>eeee</td></tr>
    <tr><td><a href="index">1001</a></td><td>aaaa</td></tr>
    <tr class="odd"><td><a href="index">2001</a></td><td>bbbb</td></tr>
    <tr><td><a href="index">3001</a></td><td>cccc</td></tr>
    <tr class="odd"><td><a href="index">4001</a></td><td>dddd</td></tr>
  </tbody>
  </head>
</table>

<table border>
<head>
  <caption>tomorrow</caption>
  <thead>
  <tr bgcolor="green">
    <tr><th>予定</th><th>場所</th></tr>
    </tr>
  </thead>
  <tbody>
    <tr><td><a href="index">1001</a></td><td><%= @event.name %></td></tr>
    <tr class="odd"><td><a href="index">2001</a></td><td>bbbb</td></tr>
    <tr><td><a href="index">3001</a></td><td>cccc</td></tr>
    <tr class="odd"><td><a href="index">4001</a></td><td>dddd</td></tr>
    <tr><td><a href="index">5001</a></td><td>eeee</td></tr>
    <tr><td><a href="index">1001</a></td><td>aaaa</td></tr>
    <tr class="odd"><td><a href="index">2001</a></td><td>bbbb</td></tr>
    <tr><td><a href="index">3001</a></td><td>cccc</td></tr>
    <tr class="odd"><td><a href="index">4001</a></td><td>ddd</td></tr>
    <tr><td><a href="index">5001</a></td><td>eeee</td></tr>
    <tr><td><a href="index">1001</a></td><td>aaaa</td></tr>
    <tr class="odd"><td><a href="index">2001</a></td><td>bbbb</td></tr>
    <tr><td><a href="index">3001</a></td><td>cccc</td></tr>
    <tr class="odd"><td><a href="index">4001</a></td><td>dddd</td></tr>
    <tr><td><a href="index">5001</a></td><td>eeee</td></tr>
    <tr><td><a href="index">1001</a></td><td>aaaa</td></tr>
    <tr class="odd"><td><a href="index">2001</a></td><td>bbbb</td></tr>
    <tr><td><a href="index">3001</a></td><td>cccc</td></tr>
    <tr class="odd"><td><a href="index">4001</a></td><td>dddd</td></tr>
    <tr><td><a href="index">5001</a></td><td>eeee</td></tr>
    <tr><td><a href="index">1001</a></td><td>aaaa</td></tr>
    <tr class="odd"><td><a href="index">2001</a></td><td>bbbb</td></tr>
    <tr><td><a href="index">3001</a></td><td>cccc</td></tr>
    <tr class="odd"><td><a href="index">4001</a></td><td>dddd</td></tr>
  </tbody>
  </head>
</table>

<br>
</div>
<%#= javascript_include_tag "event_calendar" %>
<div id="group">
<div id="calendar">
<%#= link_to("newold", :controller => "events", :action => "new") %>
<%= link_to 'new', '#', class: 'newopen' %>
<%= link_to 'edit', '#', class: 'editopen' %>
<%= raw(event_calendar) %>
</div>
<div id=detail><%= render partial: 'detail', locals:{event: @event, id: params[:id]} %></div>
<div id=todolist><%= render partial: 'todolist', locals:{todos: @todos, new_todo: @new_todo} %></div>
</div>
<div id="newmodal" style="display:none;">
<%= form_for @new_event, url: '/event/create', :html => {:onsubmit => "return selectedDates()"} do |f| %>
    <%= f.hidden_field :id %>
    <p><b><%= f.label :name, "タイトル" %></b><br>
    <%= f.text_field :name %></p>
    <p><b><%= f.label :start_at, "開始時刻" %></b><br>
      <%= raw sprintf(f.datetime_select(:start_at, :default => Time.now.in_time_zone('Tokyo'), :use_month_numbers => true, :date_separator => '%s', :datetime_separator => ' %s', :time_separator => '%s'),'年 ','月 ','日 ','時 ')+'分'%></p>
      <p><b><%= f.label :end_at,"終了時刻" %></b><br>
      <%= raw sprintf(f.datetime_select(:end_at, :default => Time.now.in_time_zone('Tokyo'), :use_month_numbers => true, :date_separator => '%s', :datetime_separator => ' %s', :time_separator => '%s'),'年 ','月 ','日 ','時 ')+'分'%></p>
    <p><b><%= f.label :place, "場所" %></b><br>
    <%= f.text_field :place %></p>
    <p><b><%= f.label :person, "相手" %></b><br>
    <%= f.text_field :person %></p>
    <p><b><%= f.label :baggage, "持ち物" %></b><br>
    <%= f.text_field :baggage %></p>
    <p><b><%= f.label :category, "カテゴリ"%></b><br>
    <%= f.select :category, [["遊び", 1],["研究室", 2],["バイト", 3],["授業", 4],["その他",0]] %></p>
    <div >
      <p><b>繰り返し設定</b><br>
      <%= f.check_box :mon %>
      <%= f.label :mon, "月 " %>
      <%= f.check_box :tue %>
      <%= f.label :tue, "火 " %>
      <%= f.check_box :wed %>
      <%= f.label :wed, "水 " %>
      <%= f.check_box :thu %>
      <%= f.label :thu, "木 " %>
      <%= f.check_box :fri %>
      <%= f.label :fri, "金 " %>
      <%= f.check_box :sat %>
      <%= f.label :sat, "土 " %>
      <%= f.check_box :sun %>
      <%= f.label :sun, "日 " %><br>
      <%= f.label :deadline, "繰り返し終了" %><br>
      <%= raw sprintf(f.date_select(:deadline, :default => Time.now.in_time_zone('Tokyo'), :use_month_numbers => true, :date_separator => '%s'),'年 ','月 ',)+'日'%></p>
    </div>
    <p><b><a id="button" href="javascript:;">一括登録</a></b></p>
    <p><div id="addMonth"></div></p>
    <%= f.submit "送信"%>
<% end %>
</div>

<div id="editmodal" style="display:none;">
<%#= form_for@event, url: event_path do |f| %>
<%# @event = @new_event %>
<%= form_for @event, url: '/event/create' do |f| %>
    <%= f.hidden_field :id %>
    <p><b><%= f.label :name, "タイトル" %></b><br>
    <%= f.text_field :name %></p>
    <p><b><%= f.label :start_at, "開始時刻"%></b><br>
    <%= raw sprintf(f.datetime_select(:start_at, :default => Time.now.in_time_zone('Tokyo'), :use_month_numbers => true, :date_separator => '%s', :datetime_separator => ' %s', :time_separator => '%s'),'年 ','月 ','日 ','時 ')+'分'%></p>
    <p><b><%= f.label :end_at,"終了時刻" %></b><br>
    <%= raw sprintf(f.datetime_select(:end_at, :default => Time.now.in_time_zone('Tokyo'), :use_month_numbers => true, :date_separator => '%s', :datetime_separator => ' %s', :time_separator => '%s'),'年 ','月 ','日 ','時 ')+'分'%></p>
    <p><b><%= f.label :place, "場所" %></b><br>
    <%= f.text_field :place %></p>
    <p><b><%= f.label :person, "相手" %></b><br>
    <%= f.text_field :person %></p>
    <p><b><%= f.label :baggage, "持ち物" %></b><br>
    <%= f.text_field :baggage %></p>
    <p><b><%= f.label :category, "カテゴリ"%></b><br>
    <%= f.select :category, [["遊び", 1],["研究室", 2],["バイト", 3],["授業", 4],["その他", 0]] %></p>
    <%= f.submit "送信", name:"update_button" %>
    <%= f.submit "削除", name:"delete_button", data:{:confirm => "本当に削除しますか?"} %>
    <%= f.submit "以降の繰り返し予定を削除", name:"delete_all_button", data:{:confirm => "本当に削除しますか?"} %>
<% end %>
</div>


<!-- <script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.11.custom.min.js"></script>
<script type="text/javascript"> -->
<script>
  $(function() {
    $('.newopen').click(function() {
      $('#newmodal').dialog({
        modal: true,
        resizable: true,
        width: 'auto',
        title: '新規作成'
      });
    });
    $('.editopen').click(function() {
      $('#editmodal').dialog({
        modal: true,
        resizable: true,
        width: 'auto',
        title: '編集'
      });
    });
  });
</script>

<%#= javascript_include_tag "application" %>



<script>
// Namespace

// var sel = document.getElementById('addMonth');
var PRJ = PRJ || {};
dates = [];

(function($, d, ns){
    'use strict';
 
    function pad2(arg) {
        var tmp = '00' + arg;
 
        return tmp.slice(-2, tmp.length);
    }
 
    var addMonth = {
        c: {
            done: '<a href="javascript:;" id="done">非表示</a>'
        },
        initialize: function() {
            this.$elm = $('#addMonth');
            this.$elm.datepicker({
                onSelect: $.proxy(this.handleSelect, this),
                beforeShowDay: $.proxy(this.beforeShowDay, this),
                dateFormat: 'yy/mm/dd'
            }).hide();
            this.$done = $(this.c.done);
            this.$done.click($.proxy(this.handleDone, this));
            this.$elm.append(this.$done);
            this.$btn = $('#button');
            this.$btn.click($.proxy(this.handleClick, this));
            this.selected = [];
        },
        handleClick: function() {
            this.$elm.show();
        },
        handleDone: function() {
            this.$elm.hide();
        },
        handleSelect: function(date) {
            var index = $.inArray(date, this.selected);
            if(index == -1) {
                this.selected.push(date);
                dates.push(date);
            } else {
                delete this.selected[index];
                delete dates[index];
            }
        },
        beforeShowDay: function(date) {
            var theday = date.getFullYear() + '/' +
                pad2(date.getMonth()+1)+'/'+
                pad2(date.getDate());
 
            return [true, $.inArray(theday, this.selected)>=0? 'selected':''];
        }
    };
 
    // Export
    ns.addMonth = addMonth;
 
})(jQuery, document, PRJ);
 
$(function() {
    PRJ.addMonth.initialize();
});
</script>


<!-- ++++++++++++ For input with drag ++++++++++++++++++ -->
<script>
var startCell = null;




// tableの中のcellの位置を取得する
function getCellPos(table, cell){
    var pos = new Object();
    if(cell.nodeName == "TD"){
        var x, y, cells;
        for(y=0; y<table.rows.length; y++){
            row = table.rows.item(y);
            for(x=0; x<row.cells.length; x++){
                if(row.cells.item(x) == cell){
                    pos.row = y;
                    pos.col = x;
                    return pos;
                }
            }
        }
    }
    return null;
}


// マウス移動のイベント処理
function mouseMove(table, e){
    if (!e) var e = window.event;

    var endCell = e.target;
    if(!(endCell.tagName=="TD" && startCell)){
      return false;
    }

    // セルの位置を取得
    var from = getCellPos(table, startCell);
    var to = getCellPos(table, endCell);
    if(!from || !to){
        return false;
    }

    // 色を変更
    var x, y, cells;
    for(y=0; y<table.rows.length; y++){
        row = table.rows.item(y);
        for(x=0; x<row.cells.length; x++){
            if((from.row-y)*(y-to.row)>=0 && (from.col-x)*(x-to.col)>=0)
                row.cells.item(x).style.backgroundColor = "#ffdddd";// 選択状態の色
            else
                row.cells.item(x).style.backgroundColor = "transparent";// 未選択状態の色
        }
    }
}


// マウスダウンのイベント処理
function mouseDown(table, e){
    if (!e) var e = window.event;
    startCell = e.target;
    if(startCell.tagName != "TD"){
        startCell = null;
        return;
    }
    mouseMove(table, e);
}


// マウスアップのイベント処理
function mouseUp(table, e){
    if (!e) var e = window.event;

    var endCell = e.target;
    if(!(endCell.tagName=="TD" && startCell)){
        return false;
    }

    // セルの位置を取得
    var from = getCellPos(table, startCell);
    var to = getCellPos(table, endCell);
    if(!from || !to){
        return false;
    }

    // セル内の文字を取得
    var time_start = startCell.innerText
    var time_end = endCell.innerText

    // mouseMoveで選択状態表示の更新をさせないようにする
    startCell = null;

    // ここに選択後の処理を書く
    console.log("start: "+time_start+"\n"+"end: "+time_end+"\n");
}
</script>
